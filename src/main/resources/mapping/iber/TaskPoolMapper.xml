<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.iber.portal.dao.task.TaskPoolMapper" >
  <resultMap id="BaseResultMap" type="com.iber.portal.model.task.TaskPool" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="lpn" property="lpn" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="VARCHAR" />
    <result column="type" property="type" jdbcType="TINYINT" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="task_info_id" property="taskInfoId" jdbcType="INTEGER" />
    <result column="end_park_id" property="endParkId" jdbcType="INTEGER" />
    <result column="version" property="version" javaType="INTEGER"/>
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, lpn, status, type, create_time, task_info_id,end_park_id,version
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from e_task_pool
    where id = #{id,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from e_task_pool
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.iber.portal.model.task.TaskPool" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into e_task_pool (id, lpn, status, 
      type, create_time, task_info_id
      )
    values (#{id,jdbcType=INTEGER}, #{lpn,jdbcType=VARCHAR}, #{status,jdbcType=VARCHAR}, 
      #{type,jdbcType=TINYINT}, #{createTime,jdbcType=TIMESTAMP}, #{taskInfoId,jdbcType=INTEGER}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.iber.portal.model.task.TaskPool" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into e_task_pool
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="lpn != null" >
        lpn,
      </if>
      <if test="status != null" >
        status,
      </if>
      <if test="type != null" >
        type,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="taskInfoId != null" >
        task_info_id,
      </if>
      <if test="endParkId != null" >
        end_park_id,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="lpn != null" >
        #{lpn,jdbcType=VARCHAR},
      </if>
      <if test="status != null" >
        #{status,jdbcType=VARCHAR},
      </if>
      <if test="type != null" >
        #{type,jdbcType=TINYINT},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="taskInfoId != null" >
        #{taskInfoId,jdbcType=INTEGER},
      </if>
      <if test="endParkId != null" >
        #{endParkId,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.iber.portal.model.task.TaskPool" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update e_task_pool
    <set >
      <if test="lpn != null" >
        lpn = #{lpn,jdbcType=VARCHAR},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=VARCHAR},
      </if>
      <if test="type != null" >
        type = #{type,jdbcType=TINYINT},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="taskInfoId != null" >
        task_info_id = #{taskInfoId,jdbcType=INTEGER},
      </if>
      <if test="endParkId != null" >
        end_park_id = #{endParkId,jdbcType=INTEGER},
      </if>
      <if test="version != null" >
        version = version + 1,
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
    <if test="version != null" >
      and version = #{version,jdbcType=INTEGER}
    </if>
  </update>
  <update id="updateByPrimaryKey" parameterType="com.iber.portal.model.task.TaskPool" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update e_task_pool
    set lpn = #{lpn,jdbcType=VARCHAR},
      status = #{status,jdbcType=VARCHAR},
      type = #{type,jdbcType=TINYINT},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      task_info_id = #{taskInfoId,jdbcType=INTEGER}
    where id = #{id,jdbcType=INTEGER}
  </update>

  <!--分页查找-->
  <select id="findPage" parameterType="java.util.Map" resultType="HashMap">
    SELECT
    etp.id,xc. NAME cityName,xcr.id carId,xp.id as beginPark,
    etp.lpn,
    (SELECT GROUP_CONCAT(`name`) from e_gridding_info i LEFT JOIN e_gridding_park_relation r on r.gridding_id=i.id where r.park_id = xp.id GROUP BY xp.id) gridName,
    xp. NAME parkName,
    etp.`status`,
    etp.type,
    eei.`name` empName,
    DATE_FORMAT(etp.create_time,'%Y-%m-%d %H:%i:%s') poolCreateTime,
    DATE_FORMAT(eti.create_time ,'%Y-%m-%d %H:%i:%s') taskCreateTime,
    DATE_FORMAT(eti.done_time,'%Y-%m-%d %H:%i:%s') as doneTime,
    eti.done_remark as doneRemark,
    (CASE when hour(timediff(eti.create_time,eti.done_time))>24
    then concat(FORMAT(hour(timediff(eti.create_time,eti.done_time))/24,0),"天",hour(timediff(eti.create_time,eti.done_time)) mod 24 ,"小时") ELSE
    concat(hour(timediff(eti.create_time,eti.done_time)),"小时") END ) doneExpendTime,
    (case when etp.status=1 then hour(timediff(etp.create_time,NOW())) ELSE 0  end) as timeOut,
    eti.status as taskStatus,eei.phone empPhone
    FROM
    e_task_pool etp
    INNER JOIN x_car_run xcr ON xcr.lpn = etp.lpn
    INNER JOIN x_city xc ON xcr.city_code = xc.code
    LEFT JOIN x_park xp ON xcr.park_id = xp.id
    LEFT JOIN e_task_info eti ON eti.id = etp.task_info_id
    LEFT JOIN e_employee_info eei on eei.id = eti.employee_id
    where 1=1
    <if test="lpn != null and lpn != ''">
      and etp.lpn LIKE concat('%',#{lpn,jdbcType=VARCHAR},'%')
    </if>
    <if test="cityCode != null and cityCode != ''">
      and xc.code = #{cityCode}
    </if>
    <if test="taskType != null and taskType != ''">
      and etp.type = #{taskType}
    </if>
    <if test="status != null and status != ''">
      and etp.status = #{status}
    </if>
    <if test="taskStatus != null and taskStatus != ''">
      and eti.status = #{taskStatus}
    </if>
    <if test="employeeName != null and employeeName != ''">
      and eei.name LIKE concat('%',#{employeeName,jdbcType=VARCHAR},'%')
    </if>
    <if test="employeePhone != null and employeePhone != ''">
      and eei.phone = #{employeePhone}
    </if>
    ORDER BY timeOut desc ,etp.create_time desc,etp.status asc
    <if test="from !=null and to != null">
      limit #{from,jdbcType=INTEGER}, #{to,jdbcType=INTEGER}
    </if>

  </select>
  <select id="findPageTotalCount" resultType="java.lang.Integer">
    SELECT
    COUNT(1)
    FROM
    e_task_pool etp
    INNER JOIN x_car_run xcr ON xcr.lpn = etp.lpn
    INNER JOIN x_city xc ON xcr.city_code = xc.code
    LEFT JOIN e_task_info eti ON eti.id = etp.task_info_id
    LEFT JOIN e_employee_info eei on eei.id = eti.employee_id
    where 1=1
    <if test="lpn != null and lpn != ''">
      and etp.lpn LIKE concat('%',#{lpn,jdbcType=VARCHAR},'%')
    </if>
    <if test="cityCode != null and cityCode != ''">
      and xc.code = #{cityCode}
    </if>
    <if test="taskType != null and taskType != ''">
      and etp.type = #{taskType}
    </if>
    <if test="status != null and status != ''">
      and etp.status = #{status}
    </if>
    <if test="taskStatus != null and taskStatus != ''">
      and eti.status = #{taskStatus}
    </if>
    <if test="employeeName != null and employeeName != ''">
      and eei.name LIKE concat('%',#{employeeName,jdbcType=VARCHAR},'%')
    </if>
    <if test="employeePhone != null and employeePhone != ''">
      and eei.phone = #{employeePhone}
    </if>
  </select>

  <insert id="saveTaskPoolIgnore">
    insert into e_task_pool (lpn,status,type,create_time)
    VALUES (#{lpn},1,3,now())
  </insert>


  <select id="findByStatusAndLpn" resultType="java.lang.Integer">
    select COUNT(1) from e_task_pool etp
    LEFT JOIN e_task_info eti ON eti.id= etp.task_info_id
    where etp.lpn=#{lpn} and (etp.status='1' or eti.status ='1' or eti.status ='2')
  </select>

  <update id="cancelTaskPool">
     UPDATE e_task_pool SET status='4' where lpn IN (
      SELECT lpn FROM(select etp.lpn from e_task_pool etp
      INNER JOIN x_car_run xcr on (etp.lpn=xcr.lpn and etp.status='1')
      WHERE xcr.status="useCar" OR (xcr.bat_status=1 and etp.type=3)) a
    )
  </update>
</mapper>